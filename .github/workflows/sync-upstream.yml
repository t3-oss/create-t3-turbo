name: Sync Upstream

# This workflow syncs changes from t3-oss/create-t3-turbo upstream repository.
# When merge conflicts occur:
# - If ONLY pnpm-lock.yaml conflicts: automatically resolve by accepting upstream's
#   lockfile and running 'pnpm install', then create PR with notice
# - If other files conflict: abort merge and create issue for manual resolution

on:
  schedule:
    # Run the first of every month
    - cron: "0 2 1 * *"
  workflow_dispatch: # Allow manual triggering

jobs:
  sync:
    # Only run this workflow in the original repository, not in repos created from template
    if: github.repository == 'Labrys-Group/create-t3-turbo'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Fetch all history for all branches and tags

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/t3-oss/create-t3-turbo.git || true
          git fetch upstream

      - name: Check for upstream changes
        id: check
        run: |
          # Get the latest commit from upstream main
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          # Check if we have this commit locally
          if git merge-base --is-ancestor "$UPSTREAM_COMMIT" HEAD; then
            echo "already_synced=true" >> "$GITHUB_OUTPUT"
            echo "No new changes from upstream"
          else
            echo "already_synced=false" >> "$GITHUB_OUTPUT"
            echo "New changes detected from upstream"

            # Get the list of new commits from upstream
            MERGE_BASE=$(git merge-base HEAD upstream/main)
            COMMITS=$(git log --pretty=format:"- %s ([%h](https://github.com/t3-oss/create-t3-turbo/commit/%H)) by %an" $MERGE_BASE..upstream/main)

            # Store commits in output (handle multiline)
            echo "new_commits<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create sync branch and merge upstream
        if: steps.check.outputs.already_synced == 'false'
        id: merge
        run: |
          # Create a new branch for the sync
          BRANCH_NAME="sync-upstream-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_ENV"

          # Attempt to merge upstream changes
          if git merge upstream/main --no-edit --allow-unrelated-histories; then
            echo "Merge successful"
            echo "merge_status=success" >> "$GITHUB_OUTPUT"
            # Push the branch
            git push origin "$BRANCH_NAME"
          else
            echo "Merge conflict detected"
            echo "merge_status=conflict" >> "$GITHUB_OUTPUT"
            # Don't abort - let analyze step handle conflicts
          fi

      - name: Analyze conflicts
        if: steps.check.outputs.already_synced == 'false' && steps.merge.outputs.merge_status == 'conflict'
        id: analyze
        run: |
          # Get list of conflicted files
          CONFLICTED_FILES=$(git diff --name-only --diff-filter=U)

          # Check if ONLY pnpm-lock.yaml conflicts
          if [ "$CONFLICTED_FILES" = "pnpm-lock.yaml" ]; then
            echo "only_lockfile=true" >> "$GITHUB_OUTPUT"
            echo "Only pnpm-lock.yaml conflicts detected - will auto-resolve"
          else
            echo "only_lockfile=false" >> "$GITHUB_OUTPUT"
            echo "Multiple files conflict - manual resolution required"
          fi

          # Store conflicted files for issue creation
          {
            echo "conflicted_files<<EOF"
            echo "$CONFLICTED_FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          # Abort merge if not auto-resolving
          if [ "$CONFLICTED_FILES" != "pnpm-lock.yaml" ]; then
            git merge --abort
          fi

      - name: Setup Node.js
        if: steps.check.outputs.already_synced == 'false' && steps.analyze.outputs.only_lockfile == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        if: steps.check.outputs.already_synced == 'false' && steps.analyze.outputs.only_lockfile == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10.19.0
          run_install: false

      - name: Auto-resolve lockfile conflict
        if: steps.check.outputs.already_synced == 'false' && steps.analyze.outputs.only_lockfile == 'true'
        id: auto_resolve
        run: |
          echo "Auto-resolving pnpm-lock.yaml conflict..."

          # Accept upstream's lockfile (preserves their dependency resolutions)
          git checkout --theirs pnpm-lock.yaml

          # Update lockfile based on merged package.json
          if ! pnpm install --no-frozen-lockfile; then
            echo "pnpm install failed - aborting merge"
            echo "resolution_status=failed" >> "$GITHUB_OUTPUT"
            git merge --abort
            exit 1
          fi

          # Stage the updated lockfile
          git add pnpm-lock.yaml

          # Complete the merge commit
          git commit --no-edit

          # Push the branch
          git push origin "${{ env.branch_name }}"

          echo "resolution_status=success" >> "$GITHUB_OUTPUT"
          echo "Lockfile conflict auto-resolved successfully"

      - name: Create Pull Request
        if: steps.check.outputs.already_synced == 'false' && (steps.merge.outputs.merge_status == 'success' || (steps.analyze.outputs.only_lockfile == 'true' && steps.auto_resolve.outputs.resolution_status == 'success'))
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = process.env.branch_name;

            const newCommits = process.env['new_commits'] || '';

            // Check if lockfile was auto-resolved
            const autoResolved = '${{ steps.analyze.outputs.only_lockfile }}' === 'true' && '${{ steps.auto_resolve.outputs.resolution_status }}' === 'success';

            // Build the PR body with new commits
            let prBody = 'This PR syncs changes from the upstream repository [t3-oss/create-t3-turbo](https://github.com/t3-oss/create-t3-turbo).\n\n';

            if (newCommits && newCommits.trim()) {
              prBody += '## New Commits from Upstream\n\n';
              prBody += newCommits + '\n\n';
            }

            // Add auto-resolution notice if applicable
            if (autoResolved) {
              prBody += '## ‚ö†Ô∏è Auto-Resolution Notice\n\nThe pnpm-lock.yaml file had merge conflicts and was automatically resolved by accepting upstream\'s lockfile and running `pnpm install`.\nPlease verify the lockfile changes are correct before merging.\n\n';
            }

            prBody += '## Review Notes\n';
            prBody += '- Please review the changes carefully before merging\n';
            prBody += '- Check for any conflicts with custom modifications in this fork\n';
            prBody += '- Ensure CI passes before merging\n\n';
            prBody += '---\n';
            prBody += 'ü§ñ This PR was automatically created by the sync-upstream workflow.';

            try {
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Sync with upstream t3-oss/create-t3-turbo',
                head: branchName,
                base: 'main',
                body: prBody,
              });

              console.log(`Pull request created: ${pr.html_url}`);
            } catch (error) {
              if (error.status === 422) {
                console.log('Pull request already exists or no changes to sync');
              } else {
                throw error;
              }
            }

      - name: Create Issue for Merge Conflict
        if: steps.check.outputs.already_synced == 'false' && steps.merge.outputs.merge_status == 'conflict' && steps.analyze.outputs.only_lockfile == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = process.env.branch_name;
            const conflictedFiles = `${{ steps.analyze.outputs.conflicted_files }}`;

            const issueBody = `## üîÑ Upstream Sync Failed - Merge Conflict

            The automated sync from [t3-oss/create-t3-turbo](https://github.com/t3-oss/create-t3-turbo) failed due to merge conflicts.

            ### Conflicted Files
            \`\`\`
            ${conflictedFiles}
            \`\`\`

            ### What to do
            1. Manually sync the upstream changes:
               \`\`\`bash
               git fetch upstream
               git checkout -b ${branchName}
               git merge upstream/main
               \`\`\`
            2. Resolve the conflicts in the files listed above
            3. Commit the resolved changes:
               \`\`\`bash
               git add .
               git commit -m "Resolve merge conflicts from upstream sync"
               \`\`\`
            4. Push and create a PR:
               \`\`\`bash
               git push origin ${branchName}
               \`\`\`

            ### Additional Information
            - **Workflow Run**: [${context.runId}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - **Attempted Branch**: \`${branchName}\`

            ---
            ü§ñ This issue was automatically created by the sync-upstream workflow.`;

            try {
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Upstream sync failed: Merge conflict in branch ${branchName}`,
                body: issueBody,
                labels: ['upstream-sync', 'merge-conflict']
              });

              console.log(`Issue created: ${issue.html_url}`);
            } catch (error) {
              console.error('Failed to create issue:', error);
              throw error;
            }
